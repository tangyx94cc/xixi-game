<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>婚礼宾客座位安排表</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-break-before { break-before: page; }
            body { background-color: white; }
        }
        .vertical-rl { writing-mode: vertical-rl; }
    </style>
</head>
<body class="bg-stone-100 text-stone-800 font-sans">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const SLOT_COUNT = 5;
        const SLOT_KEY_PREFIX = 'wedding_seating_slot_';
        const SLOT_META_KEY = 'wedding_seating_slots_meta';
        const ACTIVE_SLOT_KEY = 'wedding_seating_active_slot';
        const LEGACY_STORAGE_KEY = 'wedding_seating_db';
        const AUTOSAVE_DELAY_MS = 500;

        const Icons = {
            Layout: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="1"/><rect width="7" height="7" x="3" y="3"/><rect width="7" height="7" x="14" y="3"/><rect width="7" height="7" x="14" y="14"/><rect width="7" height="7" x="3" y="14"/></svg>,
            Printer: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>,
            RotateCcw: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
            Coffee: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/></svg>,
            ArrowUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></svg>,
            Database: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
        };

        const FLOOR_DATA = {
            floor1: { id: 1, name: "一楼 (1F)", description: "迎宾区 & 茶歇走廊", tables: [{ id: 't1-1', name: '包间 101', type: 'round', isPrivate: true, side: 'left' }, { id: 't1-2', name: '包间 102', type: 'round', isPrivate: true, side: 'right' }] },
            floor2: { id: 2, name: "二楼 (2F)", description: "宴会主厅", longTables: [{ id: 't2-long-1', name: '长条桌 A', type: 'long', isPrivate: false }, { id: 't2-long-2', name: '长条桌 B', type: 'long', isPrivate: false }], roundTables: [{ id: 't2-1', name: '主厅 01', type: 'round', isPrivate: false }, { id: 't2-2', name: '主厅 02', type: 'round', isPrivate: false }, { id: 't2-3', name: '主厅 03', type: 'round', isPrivate: false }, { id: 't2-4', name: '主厅 04', type: 'round', isPrivate: false }], privateRooms: [{ id: 't2-p2', name: '包间 202', type: 'round', isPrivate: true }] },
            floor3: { id: 3, name: "三楼 (3F)", description: "贵宾包间层", tables: [{ id: 't3-1', name: '包间 301', type: 'round', isPrivate: true }, { id: 't3-2', name: '包间 302', type: 'round', isPrivate: true }, { id: 't3-3', name: '包间 303', type: 'round', isPrivate: true }, { id: 't3-4', name: '包间 305', type: 'round', isPrivate: true }] }
        };

        const TABLE_GROUPS = [
            ['floor1', 'tables'],
            ['floor2', 'longTables'],
            ['floor2', 'roundTables'],
            ['floor2', 'privateRooms'],
            ['floor3', 'tables']
        ];

        function deepClone(obj) {
            return JSON.parse(JSON.stringify(obj));
        }

        function buildDefaultLayout() {
            return deepClone(FLOOR_DATA);
        }

        function normalizeSlot(slot) {
            if (!Number.isInteger(slot) || slot < 1 || slot > SLOT_COUNT) return 1;
            return slot;
        }

        function getSlotKey(slot) {
            return `${SLOT_KEY_PREFIX}${normalizeSlot(slot)}`;
        }

        function normalizeGuestData(raw) {
            if (!raw || typeof raw !== 'object' || Array.isArray(raw)) return {};
            const next = {};
            Object.entries(raw).forEach(([k, v]) => {
                if (typeof v === 'string') {
                    next[k] = v;
                }
            });
            return next;
        }

        function normalizeLayout(rawLayout) {
            const fallback = buildDefaultLayout();
            if (!rawLayout || typeof rawLayout !== 'object' || Array.isArray(rawLayout)) return fallback;

            const next = deepClone(rawLayout);
            if (typeof next.floor1?.name !== 'string') next.floor1 = fallback.floor1;
            if (typeof next.floor2?.name !== 'string') next.floor2 = fallback.floor2;
            if (typeof next.floor3?.name !== 'string') next.floor3 = fallback.floor3;

            TABLE_GROUPS.forEach(([floorKey, groupKey]) => {
                const group = next[floorKey] && next[floorKey][groupKey];
                if (!Array.isArray(group)) {
                    next[floorKey][groupKey] = deepClone(fallback[floorKey][groupKey]);
                    return;
                }
                const cleaned = group.filter(item => item && typeof item.id === 'string' && typeof item.name === 'string');
                if (cleaned.length !== fallback[floorKey][groupKey].length) {
                    next[floorKey][groupKey] = deepClone(fallback[floorKey][groupKey]);
                    return;
                }
                next[floorKey][groupKey] = cleaned;
            });

            return next;
        }

        function countFilledGuests(guestData) {
            return Object.values(guestData).filter(name => typeof name === 'string' && name.trim()).length;
        }

        function countTotalSeats(layout) {
            return TABLE_GROUPS.reduce((sum, [floorKey, groupKey]) => {
                const group = layout?.[floorKey]?.[groupKey];
                return sum + (Array.isArray(group) ? group.length * 10 : 0);
            }, 0);
        }

        function formatSavedAt(rawTime) {
            if (!rawTime) return '未保存';
            const d = new Date(rawTime);
            if (Number.isNaN(d.getTime())) return '未保存';
            return d.toLocaleString('zh-CN', { hour12: false });
        }

        function resolveDesiredTableName(currentName, userInput) {
            const trimmed = String(userInput || '').trim();
            if (!trimmed) return currentName;

            if (/\s/.test(trimmed) || /[\u4e00-\u9fff]/.test(trimmed)) {
                return trimmed;
            }

            const match = currentName.match(/^(.*?)([A-Za-z0-9]+)$/);
            if (!match) return trimmed;
            return `${match[1]}${trimmed}`;
        }

        function readSlotMeta() {
            const raw = localStorage.getItem(SLOT_META_KEY);
            if (!raw) return {};
            try {
                const parsed = JSON.parse(raw);
                if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) return {};
                return parsed;
            } catch {
                return {};
            }
        }

        function loadSlotPayload(slot) {
            const raw = localStorage.getItem(getSlotKey(slot));
            if (raw) {
                try {
                    const parsed = JSON.parse(raw);
                    if (parsed && typeof parsed === 'object' && parsed.guestData) {
                        return {
                            guestData: normalizeGuestData(parsed.guestData),
                            tableLayout: normalizeLayout(parsed.tableLayout)
                        };
                    }
                    return {
                        guestData: normalizeGuestData(parsed),
                        tableLayout: buildDefaultLayout()
                    };
                } catch {
                    return {
                        guestData: {},
                        tableLayout: buildDefaultLayout()
                    };
                }
            }

            if (slot === 1) {
                const legacyRaw = localStorage.getItem(LEGACY_STORAGE_KEY);
                if (legacyRaw) {
                    try {
                        const legacyParsed = JSON.parse(legacyRaw);
                        return {
                            guestData: normalizeGuestData(legacyParsed),
                            tableLayout: buildDefaultLayout()
                        };
                    } catch {
                        return {
                            guestData: {},
                            tableLayout: buildDefaultLayout()
                        };
                    }
                }
            }

            return {
                guestData: {},
                tableLayout: buildDefaultLayout()
            };
        }

        function App() {
            const [guestData, setGuestData] = useState({});
            const [tableLayout, setTableLayout] = useState(buildDefaultLayout());
            const [totalGuests, setTotalGuests] = useState(0);
            const [totalSeats, setTotalSeats] = useState(countTotalSeats(buildDefaultLayout()));
            const [showModal, setShowModal] = useState(false);
            const [activeSlot, setActiveSlot] = useState(1);
            const [slotMeta, setSlotMeta] = useState({});
            const [lastSavedAt, setLastSavedAt] = useState('');
            const [isAutoSaving, setIsAutoSaving] = useState(false);
            const hasLoadedRef = useRef(false);
            const dragSeatKeyRef = useRef('');

            const persistMeta = useCallback((nextMeta) => {
                localStorage.setItem(SLOT_META_KEY, JSON.stringify(nextMeta));
            }, []);

            const saveToSlot = useCallback((slot, data, layout) => {
                const safeSlot = normalizeSlot(slot);
                try {
                    const payload = {
                        guestData: normalizeGuestData(data),
                        tableLayout: normalizeLayout(layout)
                    };
                    localStorage.setItem(getSlotKey(safeSlot), JSON.stringify(payload));
                    const savedAt = new Date().toISOString();
                    const guestCount = countFilledGuests(payload.guestData);

                    setSlotMeta(prev => {
                        const next = {
                            ...prev,
                            [safeSlot]: {
                                lastSavedAt: savedAt,
                                guestCount
                            }
                        };
                        persistMeta(next);
                        return next;
                    });

                    if (safeSlot === activeSlot) {
                        setLastSavedAt(savedAt);
                    }
                    return true;
                } catch (err) {
                    console.error('保存失败:', err);
                    return false;
                }
            }, [activeSlot, persistMeta]);

            useEffect(() => {
                const initialSlotRaw = Number.parseInt(localStorage.getItem(ACTIVE_SLOT_KEY), 10);
                const initialSlot = normalizeSlot(initialSlotRaw);
                const currentMeta = readSlotMeta();
                const payload = loadSlotPayload(initialSlot);

                setActiveSlot(initialSlot);
                setSlotMeta(currentMeta);
                setGuestData(payload.guestData);
                setTableLayout(payload.tableLayout);
                setLastSavedAt(currentMeta[initialSlot]?.lastSavedAt || '');
                hasLoadedRef.current = true;
            }, []);

            useEffect(() => {
                setTotalGuests(countFilledGuests(guestData));
            }, [guestData]);

            useEffect(() => {
                setTotalSeats(countTotalSeats(tableLayout));
            }, [tableLayout]);

            useEffect(() => {
                if (!hasLoadedRef.current) return;
                setIsAutoSaving(true);
                const timer = window.setTimeout(() => {
                    saveToSlot(activeSlot, guestData, tableLayout);
                    setIsAutoSaving(false);
                }, AUTOSAVE_DELAY_MS);
                return () => window.clearTimeout(timer);
            }, [activeSlot, guestData, tableLayout, saveToSlot]);

            useEffect(() => {
                const flushNow = () => {
                    saveToSlot(activeSlot, guestData, tableLayout);
                };
                const flushWhenHidden = () => {
                    if (document.hidden) flushNow();
                };
                window.addEventListener('beforeunload', flushNow);
                document.addEventListener('visibilitychange', flushWhenHidden);
                return () => {
                    window.removeEventListener('beforeunload', flushNow);
                    document.removeEventListener('visibilitychange', flushWhenHidden);
                };
            }, [activeSlot, guestData, tableLayout, saveToSlot]);

            const remainingSeats = Math.max(totalSeats - totalGuests, 0);

            const handleNameChange = (tableId, seatIdx, value) => {
                setGuestData(prev => ({
                    ...prev,
                    [`${tableId}-${seatIdx}`]: value
                }));
            };

            const handleClearCurrent = () => {
                if (!confirm(`确定清空当前版本（Slot ${activeSlot}）的宾客数据吗？`)) return;
                setGuestData({});
            };

            const handleSwitchSlot = (slot) => {
                const targetSlot = normalizeSlot(slot);
                if (targetSlot === activeSlot) return;

                saveToSlot(activeSlot, guestData, tableLayout);
                const payload = loadSlotPayload(targetSlot);

                setActiveSlot(targetSlot);
                localStorage.setItem(ACTIVE_SLOT_KEY, String(targetSlot));
                setGuestData(payload.guestData);
                setTableLayout(payload.tableLayout);
                setLastSavedAt(slotMeta[targetSlot]?.lastSavedAt || '');
                setShowModal(false);
            };

            const handleCopyToSlot = (slot) => {
                const targetSlot = normalizeSlot(slot);
                if (targetSlot === activeSlot) return;
                saveToSlot(targetSlot, guestData, tableLayout);
            };

            const handleClearSlot = (slot) => {
                const safeSlot = normalizeSlot(slot);
                if (!confirm(`确定清空 Slot ${safeSlot} 吗？`)) return;

                localStorage.removeItem(getSlotKey(safeSlot));
                setSlotMeta(prev => {
                    const next = { ...prev };
                    delete next[safeSlot];
                    persistMeta(next);
                    return next;
                });

                if (safeSlot === activeSlot) {
                    setGuestData({});
                    setTableLayout(buildDefaultLayout());
                    setLastSavedAt('');
                }
            };

            const handleSeatDragStart = (e, tableId, seatIdx) => {
                const seatKey = `${tableId}-${seatIdx}`;
                const seatValue = (guestData[seatKey] || '').trim();
                if (!seatValue) {
                    e.preventDefault();
                    return;
                }
                dragSeatKeyRef.current = seatKey;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', seatKey);
            };

            const handleSeatDrop = (e, targetTableId, targetSeatIdx) => {
                e.preventDefault();
                const sourceKey = dragSeatKeyRef.current || e.dataTransfer.getData('text/plain');
                const targetKey = `${targetTableId}-${targetSeatIdx}`;
                dragSeatKeyRef.current = '';

                if (!sourceKey || sourceKey === targetKey) return;

                setGuestData(prev => {
                    const sourceValue = (prev[sourceKey] || '').trim();
                    const targetValue = (prev[targetKey] || '').trim();

                    // 1 对 1 对换：两个位置都必须有宾客
                    if (!sourceValue || !targetValue) return prev;

                    return {
                        ...prev,
                        [sourceKey]: targetValue,
                        [targetKey]: sourceValue
                    };
                });
            };

            const handleSeatDragEnd = () => {
                dragSeatKeyRef.current = '';
            };

            const handleTableNameCommit = (groupPath, tableId, draftName) => {
                setTableLayout(prev => {
                    const next = deepClone(prev);
                    const [floorKey, groupKey] = groupPath.split('.');
                    const group = next?.[floorKey]?.[groupKey];
                    if (!Array.isArray(group)) return prev;

                    const sourceIdx = group.findIndex(t => t.id === tableId);
                    if (sourceIdx === -1) return prev;

                    const currentName = group[sourceIdx].name;
                    const desiredName = resolveDesiredTableName(currentName, draftName);
                    const normalizedDesired = desiredName.trim().toLowerCase();
                    if (!normalizedDesired) return prev;

                    const targetIdx = group.findIndex((t, idx) => idx !== sourceIdx && t.name.trim().toLowerCase() === normalizedDesired);

                    if (targetIdx !== -1) {
                        const temp = group[sourceIdx];
                        group[sourceIdx] = group[targetIdx];
                        group[targetIdx] = temp;
                        return next;
                    }

                    group[sourceIdx].name = desiredName;
                    return next;
                });
            };

            return (
                <div className="min-h-screen pb-20">
                    <header className="bg-white border-b border-stone-200 sticky top-0 z-50 no-print shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <h1 className="text-2xl font-serif text-rose-900 flex items-center gap-2"><Icons.Layout /> 婚礼座位表</h1>
                                <p className="text-sm text-stone-500 mt-1">已安排 {totalGuests} 位宾客 · 剩余空位 {remainingSeats} 个（总座位 {totalSeats}）</p>
                                <p className="text-xs text-stone-400 mt-1">当前版本 Slot {activeSlot} · 自动保存：{isAutoSaving ? '保存中...' : '已开启'} · 上次保存 {formatSavedAt(lastSavedAt)}</p>
                                <div className="flex flex-wrap gap-2 mt-2">
                                    {Array.from({ length: SLOT_COUNT }, (_, i) => {
                                        const slot = i + 1;
                                        const isCurrent = slot === activeSlot;
                                        return (
                                            <button
                                                key={slot}
                                                onClick={() => handleSwitchSlot(slot)}
                                                className={`px-2 py-1 text-xs rounded border ${isCurrent ? 'bg-rose-900 text-white border-rose-900' : 'bg-white text-stone-600 border-stone-200 hover:bg-stone-50'}`}
                                            >
                                                Slot {slot}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setShowModal(true)} className="flex items-center gap-2 px-3 py-2 bg-stone-100 text-stone-700 rounded hover:bg-stone-200 text-sm"><Icons.Database /> 版本管理</button>
                                <button onClick={handleClearCurrent} className="flex items-center gap-2 px-3 py-2 text-stone-500 hover:text-red-600 text-sm"><Icons.RotateCcw /> 清空当前版本</button>
                                <button onClick={() => window.print()} className="flex items-center gap-2 px-4 py-2 bg-rose-900 text-white rounded hover:bg-rose-800 shadow-md text-sm"><Icons.Printer /> 打印</button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-[1600px] mx-auto px-4 py-8 space-y-12">
                        <Section title={tableLayout.floor1.name} desc={`${tableLayout.floor1.description}（拖拽宾客姓名可 1 对 1 对换；改桌号可调换桌位）`}>
                            <div className="flex flex-col md:flex-row justify-center items-center gap-12 mt-8 min-h-[300px]">
                                <RoundTable
                                    table={tableLayout.floor1.tables[0]}
                                    groupPath="floor1.tables"
                                    data={guestData}
                                    onChange={handleNameChange}
                                    onSeatDragStart={handleSeatDragStart}
                                    onSeatDrop={handleSeatDrop}
                                    onSeatDragEnd={handleSeatDragEnd}
                                    onTableNameCommit={handleTableNameCommit}
                                />
                                <div className="w-48 h-80 flex flex-col items-center justify-center border-x-2 border-dashed border-stone-300 bg-stone-50 rounded-lg px-4 gap-4 no-print">
                                    <div className="text-stone-400 font-serif text-lg tracking-widest vertical-rl">茶歇走廊</div>
                                    <div className="text-amber-600"><Icons.Coffee /></div>
                                    <div className="w-full h-px bg-stone-300"></div>
                                    <div className="flex flex-col items-center gap-1 text-stone-400 text-xs"><Icons.ArrowUp /> 通往二楼</div>
                                </div>
                                <RoundTable
                                    table={tableLayout.floor1.tables[1]}
                                    groupPath="floor1.tables"
                                    data={guestData}
                                    onChange={handleNameChange}
                                    onSeatDragStart={handleSeatDragStart}
                                    onSeatDrop={handleSeatDrop}
                                    onSeatDragEnd={handleSeatDragEnd}
                                    onTableNameCommit={handleTableNameCommit}
                                />
                            </div>
                        </Section>

                        <Section title={tableLayout.floor2.name} desc={tableLayout.floor2.description}>
                            <div className="flex flex-col gap-12 mt-8">
                                <div className="flex justify-center gap-8 md:gap-24 flex-wrap">
                                    {tableLayout.floor2.longTables.map(t => (
                                        <LongTable
                                            key={t.id}
                                            table={t}
                                            groupPath="floor2.longTables"
                                            data={guestData}
                                            onChange={handleNameChange}
                                            onSeatDragStart={handleSeatDragStart}
                                            onSeatDrop={handleSeatDrop}
                                            onSeatDragEnd={handleSeatDragEnd}
                                            onTableNameCommit={handleTableNameCommit}
                                        />
                                    ))}
                                </div>
                                <div className="flex justify-center gap-8 flex-wrap">
                                    {tableLayout.floor2.roundTables.map(t => (
                                        <RoundTable
                                            key={t.id}
                                            table={t}
                                            groupPath="floor2.roundTables"
                                            data={guestData}
                                            onChange={handleNameChange}
                                            onSeatDragStart={handleSeatDragStart}
                                            onSeatDrop={handleSeatDrop}
                                            onSeatDragEnd={handleSeatDragEnd}
                                            onTableNameCommit={handleTableNameCommit}
                                        />
                                    ))}
                                </div>
                                <div className="flex justify-end items-center gap-8 px-4 md:px-12">
                                    <div className="hidden md:flex flex-col items-center text-stone-300 no-print"><div className="w-32 h-32 border-2 border-stone-100 rounded-full flex items-center justify-center text-xs">舞台区域</div></div>
                                    <div className="bg-amber-50/50 p-4 rounded-3xl border border-amber-100">
                                        <RoundTable
                                            table={tableLayout.floor2.privateRooms[0]}
                                            groupPath="floor2.privateRooms"
                                            data={guestData}
                                            onChange={handleNameChange}
                                            onSeatDragStart={handleSeatDragStart}
                                            onSeatDrop={handleSeatDrop}
                                            onSeatDragEnd={handleSeatDragEnd}
                                            onTableNameCommit={handleTableNameCommit}
                                        />
                                    </div>
                                </div>
                            </div>
                        </Section>

                        <Section title={tableLayout.floor3.name} desc={tableLayout.floor3.description}>
                            <div className="flex flex-wrap justify-center xl:justify-between gap-8 mt-8 px-4">
                                {tableLayout.floor3.tables.map(t => (
                                    <RoundTable
                                        key={t.id}
                                        table={t}
                                        groupPath="floor3.tables"
                                        data={guestData}
                                        onChange={handleNameChange}
                                        onSeatDragStart={handleSeatDragStart}
                                        onSeatDrop={handleSeatDrop}
                                        onSeatDragEnd={handleSeatDragEnd}
                                        onTableNameCommit={handleTableNameCommit}
                                    />
                                ))}
                            </div>
                        </Section>
                    </main>

                    {showModal && (
                        <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6">
                                <div className="flex justify-between items-center mb-5">
                                    <h3 className="text-lg font-bold">版本管理（5 个 Slot）</h3>
                                    <button onClick={() => setShowModal(false)}><Icons.X /></button>
                                </div>
                                <div className="space-y-3">
                                    {Array.from({ length: SLOT_COUNT }, (_, i) => {
                                        const slot = i + 1;
                                        const isCurrent = slot === activeSlot;
                                        const meta = slotMeta[slot] || {};
                                        const slotGuestCount = isCurrent ? totalGuests : (meta.guestCount || 0);
                                        const slotSavedAt = isCurrent ? lastSavedAt : meta.lastSavedAt;
                                        return (
                                            <div key={slot} className={`border rounded-lg p-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3 ${isCurrent ? 'border-rose-300 bg-rose-50/40' : 'border-stone-200'}`}>
                                                <div>
                                                    <p className="font-semibold">Slot {slot} {isCurrent ? '（当前）' : ''}</p>
                                                    <p className="text-xs text-stone-500 mt-1">已安排 {slotGuestCount} 位 · 上次保存 {formatSavedAt(slotSavedAt)}</p>
                                                </div>
                                                <div className="flex gap-2">
                                                    {!isCurrent && (
                                                        <button onClick={() => handleSwitchSlot(slot)} className="px-3 py-1.5 rounded bg-rose-900 text-white text-xs hover:bg-rose-800">切换</button>
                                                    )}
                                                    {!isCurrent && (
                                                        <button onClick={() => handleCopyToSlot(slot)} className="px-3 py-1.5 rounded bg-blue-600 text-white text-xs hover:bg-blue-700">复制到此</button>
                                                    )}
                                                    <button onClick={() => handleClearSlot(slot)} className="px-3 py-1.5 rounded border border-stone-300 text-stone-600 text-xs hover:bg-stone-50">清空</button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function Section({ title, desc, children }) {
            return (
                <section className="bg-white rounded-2xl shadow-sm border border-stone-200 p-8 print:border-none print:shadow-none print:p-0 print-break-before">
                    <div className="flex flex-col items-center border-b border-rose-100 pb-4 mb-6">
                        <h2 className="text-2xl md:text-3xl font-serif text-rose-950">{title}</h2>
                        <span className="text-stone-500 font-light mt-1 text-center">{desc}</span>
                    </div>
                    {children}
                </section>
            );
        }

        function RoundTable({ table, groupPath, data, onChange, onSeatDragStart, onSeatDrop, onSeatDragEnd, onTableNameCommit }) {
            const radius = 130;
            const centerX = 160;
            const centerY = 160;
            const [draftName, setDraftName] = useState(table.name);

            useEffect(() => {
                setDraftName(table.name);
            }, [table.name]);

            const commitName = () => {
                if (!draftName.trim()) {
                    setDraftName(table.name);
                    return;
                }
                onTableNameCommit(groupPath, table.id, draftName);
            };

            return (
                <div className="relative w-[320px] h-[320px] print:w-[280px] print:h-[280px] break-inside-avoid">
                    <div className={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-36 h-36 rounded-full flex flex-col items-center justify-center text-center p-2 z-10 shadow-lg border-4 ${table.isPrivate ? 'bg-amber-50 border-amber-200 text-amber-900' : 'bg-white border-rose-100 text-rose-900'}`}>
                        <input
                            type="text"
                            value={draftName}
                            onChange={e => setDraftName(e.target.value)}
                            onBlur={commitName}
                            onKeyDown={e => {
                                if (e.key === 'Enter') e.currentTarget.blur();
                                if (e.key === 'Escape') {
                                    setDraftName(table.name);
                                    e.currentTarget.blur();
                                }
                            }}
                            className="w-full text-center bg-transparent font-serif font-bold text-base leading-tight border-b border-dashed border-stone-300 focus:border-rose-400 outline-none"
                            title="修改桌号：输入已存在桌号可整体调换桌位"
                        />
                        <span className="text-[10px] text-stone-400 mt-1 no-print">改桌号可整体调换桌位</span>
                    </div>
                    {Array.from({ length: 10 }).map((_, i) => {
                        const rad = ((i * 36) - 90) * Math.PI / 180;
                        const key = `${table.id}-${i}`;
                        const seatValue = data[key] || '';
                        return (
                            <div
                                key={i}
                                className="absolute -translate-x-1/2 -translate-y-1/2 flex flex-col items-center gap-1 scale-90 print:scale-75"
                                style={{ left: centerX + radius * Math.cos(rad), top: centerY + radius * Math.sin(rad) }}
                                draggable={Boolean(seatValue.trim())}
                                onDragStart={e => onSeatDragStart(e, table.id, i)}
                                onDragOver={e => e.preventDefault()}
                                onDrop={e => onSeatDrop(e, table.id, i)}
                                onDragEnd={onSeatDragEnd}
                                title={seatValue.trim() ? '拖拽到另一个已安排宾客位置进行对换' : '空座位不可作为拖拽源'}
                            >
                                <div className={`w-8 h-8 rounded-full shadow-sm border flex items-center justify-center text-xs font-bold ${seatValue ? 'bg-rose-500 border-rose-600 text-white cursor-move' : 'bg-white border-stone-300'}`}>{i + 1}</div>
                                <input type="text" value={seatValue} onChange={e => onChange(table.id, i, e.target.value)} placeholder="宾客" className="w-20 text-center bg-white/90 border-b border-stone-300 focus:border-rose-500 outline-none text-xs py-0.5" />
                            </div>
                        );
                    })}
                </div>
            );
        }

        function LongTable({ table, groupPath, data, onChange, onSeatDragStart, onSeatDrop, onSeatDragEnd, onTableNameCommit }) {
            const [draftName, setDraftName] = useState(table.name);

            useEffect(() => {
                setDraftName(table.name);
            }, [table.name]);

            const commitName = () => {
                if (!draftName.trim()) {
                    setDraftName(table.name);
                    return;
                }
                onTableNameCommit(groupPath, table.id, draftName);
            };

            return (
                <div className="w-[380px] flex flex-col gap-2 break-inside-avoid my-auto">
                    <div className="flex justify-between px-4">{[0,1,2,3,4].map(i => <Seat key={i} idx={i} tableId={table.id} data={data} onChange={onChange} pos="top" onSeatDragStart={onSeatDragStart} onSeatDrop={onSeatDrop} onSeatDragEnd={onSeatDragEnd} />)}</div>
                    <div className={`h-24 w-full rounded-lg border-2 flex items-center justify-center shadow-md ${table.isPrivate ? 'bg-amber-50 border-amber-200' : 'bg-white border-stone-200'}`}>
                        <div className="text-center px-4 w-full">
                            <input
                                type="text"
                                value={draftName}
                                onChange={e => setDraftName(e.target.value)}
                                onBlur={commitName}
                                onKeyDown={e => {
                                    if (e.key === 'Enter') e.currentTarget.blur();
                                    if (e.key === 'Escape') {
                                        setDraftName(table.name);
                                        e.currentTarget.blur();
                                    }
                                }}
                                className="w-full text-center bg-transparent font-serif font-bold text-stone-800 border-b border-dashed border-stone-300 focus:border-rose-400 outline-none"
                                title="修改桌号：输入已存在桌号可整体调换桌位"
                            />
                            <p className="text-[10px] text-stone-400 mt-1 no-print">改桌号可整体调换桌位</p>
                        </div>
                    </div>
                    <div className="flex justify-between px-4">{[5,6,7,8,9].map(i => <Seat key={i} idx={i} tableId={table.id} data={data} onChange={onChange} pos="bottom" onSeatDragStart={onSeatDragStart} onSeatDrop={onSeatDrop} onSeatDragEnd={onSeatDragEnd} />)}</div>
                </div>
            );
        }

        function Seat({ idx, tableId, data, onChange, pos, onSeatDragStart, onSeatDrop, onSeatDragEnd }) {
            const key = `${tableId}-${idx}`;
            const seatValue = data[key] || '';

            return (
                <div
                    className={`flex flex-col items-center gap-1 ${pos === 'bottom' ? 'flex-col-reverse' : ''}`}
                    draggable={Boolean(seatValue.trim())}
                    onDragStart={e => onSeatDragStart(e, tableId, idx)}
                    onDragOver={e => e.preventDefault()}
                    onDrop={e => onSeatDrop(e, tableId, idx)}
                    onDragEnd={onSeatDragEnd}
                    title={seatValue.trim() ? '拖拽到另一个已安排宾客位置进行对换' : '空座位不可作为拖拽源'}
                >
                    <div className={`w-8 h-7 rounded-sm border shadow-sm flex items-center justify-center text-[10px] font-bold ${seatValue ? 'bg-blue-500 border-blue-600 text-white cursor-move' : 'bg-white border-stone-300'}`}>{idx + 1}</div>
                    <input type="text" value={seatValue} onChange={e => onChange(tableId, idx, e.target.value)} placeholder="姓名" className="w-16 text-center text-xs border border-stone-200 rounded py-1 px-0.5 focus:border-blue-500 outline-none" />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
